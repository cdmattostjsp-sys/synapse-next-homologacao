import sys, os
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '../../')))
# ==========================================================
# ğŸ“œ Edital â€“ Minuta do Edital de LicitaÃ§Ã£o
# SynapseNext â€“ Secretaria de AdministraÃ§Ã£o e Abastecimento (TJSP)
# ==========================================================

import streamlit as st
from io import BytesIO
from docx import Document
from docx.shared import Pt
from utils.ui_components import aplicar_estilo_global, exibir_cabecalho_padrao
from utils.agents_bridge import AgentsBridge
import json, os

# ==========================================================
# âš™ï¸ ConfiguraÃ§Ã£o da pÃ¡gina
# ==========================================================
st.set_page_config(page_title="ğŸ“œ Edital â€“ Minuta", layout="wide", page_icon="ğŸ“œ")
aplicar_estilo_global()

exibir_cabecalho_padrao(
    "ğŸ“œ Minuta do Edital de LicitaÃ§Ã£o",
    "GeraÃ§Ã£o automatizada com IA institucional a partir do TR/ETP/DFD"
)
st.divider()

# ==========================================================
# ğŸ§© NormalizaÃ§Ã£o de dados (prioridade TR > ETP > DFD > Insumo)
# ==========================================================
def _extract_from_last_insumo() -> dict:
    insumo = st.session_state.get("last_insumo")
    if not insumo:
        return {}
    raw = insumo.get("campos_ai", {}) or {}
    if isinstance(raw, dict) and "campos_ai" in raw:
        return raw["campos_ai"]
    if isinstance(raw, dict):
        return raw
    if isinstance(raw, str):
        try:
            parsed = json.loads(raw)
            return parsed.get("campos_ai", parsed)
        except Exception:
            return {}
    return {}

def _defaults_edital() -> dict:
    last_tr = st.session_state.get("last_tr", {}) or {}
    last_etp = st.session_state.get("last_etp", {}) or {}
    last_dfd = st.session_state.get("last_dfd", {}) or {}
    from_insumo = _extract_from_last_insumo()

    def pick(key, default=""):
        return (
            last_tr.get(key)
            or last_etp.get(key)
            or last_dfd.get(key)
            or from_insumo.get(key)
            or default
        )

    return {
        "unidade_solicitante": pick("unidade_solicitante"),
        "responsavel_tecnico": pick("responsavel_tecnico", pick("responsavel")),
        "objeto": pick("objeto"),
        "modalidade": "",
        "regime_execucao": "",
        "base_legal": "Lei nÂº 14.133/2021",
        "justificativa_modalidade": pick("justificativa", pick("justificativa_tecnica")),
        "habilitacao": "",
        "criterios_julgamento": pick("criterios_julgamento"),
        "prazo_execucao": pick("prazo_execucao"),
        "forma_pagamento": "",
        "penalidades": "",
        "observacoes_finais": "",
    }

# ==========================================================
# ğŸ›ï¸ Contexto da sessÃ£o
# ==========================================================
cols = st.columns(3)
for i, (label, cond, msg_ok, msg_info) in enumerate([
    ("TR", "last_tr", "âœ… TR detectado: o Edital serÃ¡ baseado nele.", "â„¹ï¸ Nenhum TR detectado."),
    ("ETP", "last_etp", "âœ… ETP detectado: dados complementares disponÃ­veis.", "â„¹ï¸ Nenhum ETP detectado."),
    ("DFD", "last_dfd", "âœ… DFD detectado: origem de dados disponÃ­vel.", "â„¹ï¸ Nenhum DFD detectado."),
]):
    with cols[i]:
        if st.session_state.get(cond):
            st.success(msg_ok)
        else:
            st.info(msg_info)

if st.session_state.get("last_insumo"):
    insumo = st.session_state["last_insumo"]
    st.info(f"ğŸ“ Insumo ativo: {insumo.get('nome','â€”')} (Artefato: {insumo.get('artefato','â€”')})")

st.divider()

# ==========================================================
# ğŸ§¾ FormulÃ¡rio do Edital (auto-preenchido e editÃ¡vel)
# ==========================================================
st.subheader("1ï¸âƒ£ Entrada â€“ InformaÃ§Ãµes do Edital")

defaults = _defaults_edital()

with st.form("form_edital"):
    unidade = st.text_input("Unidade solicitante", value=defaults.get("unidade_solicitante", ""))
    responsavel_tecnico = st.text_input("ResponsÃ¡vel tÃ©cnico", value=defaults.get("responsavel_tecnico", ""))
    objeto = st.text_area("Objeto da licitaÃ§Ã£o", value=defaults.get("objeto", ""), height=90)
    modalidade = st.text_input("Modalidade de licitaÃ§Ã£o", value=defaults.get("modalidade", ""))
    regime_execucao = st.text_input("Regime de execuÃ§Ã£o", value=defaults.get("regime_execucao", ""))
    base_legal = st.text_input("Base legal", value=defaults.get("base_legal", "Lei nÂº 14.133/2021"))
    justificativa_modalidade = st.text_area(
        "Justificativa da escolha da modalidade / fundamentaÃ§Ã£o",
        value=defaults.get("justificativa_modalidade", ""),
        height=100
    )
    habilitacao = st.text_area("Requisitos de habilitaÃ§Ã£o", value=defaults.get("habilitacao", ""), height=90)
    criterios_julgamento = st.text_area("CritÃ©rios de julgamento", value=defaults.get("criterios_julgamento", ""), height=90)
    prazo_execucao = st.text_input("Prazo de entrega / execuÃ§Ã£o", value=defaults.get("prazo_execucao", ""))
    forma_pagamento = st.text_input("Forma de pagamento", value=defaults.get("forma_pagamento", ""))
    penalidades = st.text_area("Penalidades e sanÃ§Ãµes", value=defaults.get("penalidades", ""), height=90)
    observacoes_finais = st.text_area("ObservaÃ§Ãµes finais", value=defaults.get("observacoes_finais", ""), height=80)

    gerar_ia = st.form_submit_button("âš™ï¸ Gerar minuta com IA institucional")
    submitted = st.form_submit_button("ğŸ’¾ Gerar minuta manual")

# ==========================================================
# âš™ï¸ GeraÃ§Ã£o IA â€“ Edital.IA
# ==========================================================
if gerar_ia:
    st.info("Executando agente Edital institucional...")
    metadata = {
        "objeto": objeto,
        "modalidade": modalidade,
        "regime_execucao": regime_execucao,
        "base_legal": base_legal,
        "criterios_julgamento": criterios_julgamento,
        "prazo_execucao": prazo_execucao,
        "forma_pagamento": forma_pagamento,
        "penalidades": penalidades,
    }
    try:
        bridge = AgentsBridge("EDITAL")
        resultado = bridge.generate(metadata)
        st.success("âœ… Minuta gerada com sucesso pelo agente Edital.IA!")
        st.json(resultado)
        st.session_state["last_edital"] = resultado.get("secoes", {})
    except Exception as e:
        st.error(f"Erro ao gerar minuta com IA: {e}")

# ==========================================================
# ğŸ’¾ GeraÃ§Ã£o manual
# ==========================================================
if submitted:
    edital_data = {
        "unidade_solicitante": unidade,
        "responsavel_tecnico": responsavel_tecnico,
        "objeto": objeto,
        "modalidade": modalidade,
        "regime_execucao": regime_execucao,
        "base_legal": base_legal,
        "justificativa_modalidade": justificativa_modalidade,
        "habilitacao": habilitacao,
        "criterios_julgamento": criterios_julgamento,
        "prazo_execucao": prazo_execucao,
        "forma_pagamento": forma_pagamento,
        "penalidades": penalidades,
        "observacoes_finais": observacoes_finais,
    }
    st.success("âœ… Minuta do Edital gerada manualmente!")
    st.json(edital_data)
    st.session_state["last_edital"] = edital_data

# ==========================================================
# ğŸ“¤ ExportaÃ§Ã£o
# ==========================================================
if st.session_state.get("last_edital"):
    st.divider()
    st.subheader("ğŸ“¤ ExportaÃ§Ã£o de Documento")

    edital_data = st.session_state["last_edital"]
    doc = Document()
    doc.add_heading("Minuta do Edital de LicitaÃ§Ã£o", level=1)
    for k, v in edital_data.items():
        p = doc.add_paragraph()
        p.add_run(f"{k}: ").bold = True
        p.add_run(str(v) or "â€”")

    buffer = BytesIO()
    doc.save(buffer)
    buffer.seek(0)
    st.download_button(
        label="ğŸ’¾ Baixar Edital_rascunho.docx",
        data=buffer,
        file_name="Edital_rascunho.docx",
        mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    )

st.caption("ğŸ’¡ O agente Edital.IA gera automaticamente as clÃ¡usulas e disposiÃ§Ãµes padrÃ£o com base nos dados do TR, ETP e DFD.")
