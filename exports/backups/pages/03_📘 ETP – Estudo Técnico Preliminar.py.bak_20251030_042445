import sys, os
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '../../')))
import streamlit as st
from utils.ui_components import aplicar_estilo_global, exibir_cabecalho_padrao
from utils.agents_bridge import AgentsBridge
from io import BytesIO
from docx import Document
import json
import os

# ==========================================================
# ğŸ“˜ ETP â€“ Estudo TÃ©cnico Preliminar
# SynapseNext â€“ Secretaria de AdministraÃ§Ã£o e Abastecimento (TJSP)
# ==========================================================
st.set_page_config(page_title="ğŸ“˜ ETP â€“ Estudo TÃ©cnico Preliminar", layout="wide", page_icon="ğŸ“˜")
aplicar_estilo_global()

exibir_cabecalho_padrao(
    "ğŸ“˜ Estudo TÃ©cnico Preliminar (ETP)",
    "GeraÃ§Ã£o automatizada com IA institucional a partir da DFD"
)
st.divider()

# ==========================================================
# ğŸ” Recupera dados da DFD, se disponÃ­veis
# ==========================================================
dfd_data = st.session_state.get("last_dfd", {})

if dfd_data:
    st.success("ğŸ“ DFD detectado. Dados serÃ£o usados como base para o ETP.")
    with st.expander("ğŸ§¾ Visualizar DFD ativo"):
        st.json(dfd_data)
else:
    st.info("Nenhum DFD ativo encontrado. VocÃª pode preencher o ETP manualmente.")
st.divider()

# ==========================================================
# ğŸ§¾ FormulÃ¡rio Institucional ETP
# ==========================================================
st.subheader("1ï¸âƒ£ Entrada â€“ Dados TÃ©cnicos")

with st.form("form_etp"):
    objeto = st.text_area("Objeto da contrataÃ§Ã£o", value=dfd_data.get("objeto", ""), height=80)
    justificativa = st.text_area("Justificativa tÃ©cnica", value=dfd_data.get("justificativa", ""), height=100)
    solucoes = st.text_area("SoluÃ§Ãµes de mercado identificadas", height=100)
    requisitos = st.text_area("Requisitos mÃ­nimos e desempenho esperado", height=100)
    estimativa = st.text_area("Estimativa de custos", height=80)
    riscos = st.text_area("Riscos associados", height=80)
    responsavel = st.text_input("ResponsÃ¡vel tÃ©cnico", value="")
    gerar_ia = st.form_submit_button("âš™ï¸ Gerar rascunho com IA institucional")
    submitted = st.form_submit_button("ğŸ’¾ Gerar rascunho manual")

# ==========================================================
# âš™ï¸ GeraÃ§Ã£o IA Institucional
# ==========================================================
if gerar_ia:
    st.info("Executando agente ETP institucional...")
    metadata = {
        "objeto": objeto,
        "justificativa_tecnica": justificativa,
        "solucoes_mercado": solucoes,
        "requisitos": requisitos,
        "estimativa_custos": estimativa,
        "riscos": riscos,
        "responsavel": responsavel,
    }
    try:
        bridge = AgentsBridge("ETP")
        resultado = bridge.generate(metadata)
        st.success("âœ… Rascunho gerado com sucesso pelo agente ETP.IA!")
        st.json(resultado)
        st.session_state["last_etp"] = resultado.get("secoes", {})
    except Exception as e:
        st.error(f"Erro ao gerar rascunho com IA: {e}")

# ==========================================================
# ğŸ’¾ GeraÃ§Ã£o manual
# ==========================================================
if submitted:
    etp_data = {
        "objeto": objeto,
        "justificativa_tecnica": justificativa,
        "solucoes_mercado": solucoes,
        "requisitos": requisitos,
        "estimativa_custos": estimativa,
        "riscos": riscos,
        "responsavel": responsavel,
    }
    st.success("âœ… Rascunho de ETP gerado manualmente!")
    st.json(etp_data)
    st.session_state["last_etp"] = etp_data

# ==========================================================
# ğŸ“¤ ExportaÃ§Ã£o
# ==========================================================
if "last_etp" in st.session_state and st.session_state["last_etp"]:
    st.divider()
    st.subheader("ğŸ“¤ ExportaÃ§Ã£o de Documento")
    st.info("Baixe o Ãºltimo ETP gerado em formato Word editÃ¡vel.")

    etp_data = st.session_state["last_etp"]
    doc = Document()
    doc.add_heading("Estudo TÃ©cnico Preliminar (ETP)", level=1)
    for k, v in etp_data.items():
        p = doc.add_paragraph()
        p.add_run(f"{k}: ").bold = True
        p.add_run(str(v) or "â€”")

    buffer = BytesIO()
    doc.save(buffer)
    buffer.seek(0)
    st.download_button("ğŸ’¾ Baixar ETP_rascunho.docx", buffer, file_name="ETP_rascunho.docx")

    if st.button("ğŸ“¦ Exportar ETP (JSON)"):
        out_dir = "exports"
        os.makedirs(out_dir, exist_ok=True)
        path = os.path.join(out_dir, "etp_teste.json")
        with open(path, "w", encoding="utf-8") as f:
            json.dump(etp_data, f, ensure_ascii=False, indent=2)
        st.success(f"âœ… ETP exportado com sucesso para {path}")

st.caption("ğŸ’¡ *Dica:* O botÃ£o 'âš™ï¸ Gerar rascunho com IA institucional' usa o agente ETP.IA para gerar automaticamente o texto tÃ©cnico.")