# -*- coding: utf-8 -*-
"""
import sys, os
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '../../')))
09_‚ö†Ô∏è Alertas.py ‚Äì Painel de Alertas Proativos
==============================================================
Exibe resultados do m√≥dulo utils/alertas_pipeline.py,
com classifica√ß√£o por severidade, √°rea e artefato.

Vers√£o: SynapseNext vNext (TJSP/SAAB)
==============================================================
"""

import streamlit as st
from utils.alertas_pipeline import evaluate_alerts, export_alerts_json, DEFAULTS
from datetime import datetime
import json
import os

# --------------------------------------------------------------
# Configura√ß√£o de p√°gina
# --------------------------------------------------------------
st.set_page_config(page_title="‚ö†Ô∏è Alertas Proativos", layout="wide")
st.title("‚ö†Ô∏è Painel de Alertas Proativos ‚Äì SynapseNext vNext")
st.caption("An√°lise de auditoria, coer√™ncia e consist√™ncia documental.")

# --------------------------------------------------------------
# Se√ß√£o lateral ‚Äì par√¢metros
# --------------------------------------------------------------
with st.sidebar:
    st.header("‚öôÔ∏è Configura√ß√µes de an√°lise")
    st.write("Ajuste os par√¢metros e reexecute a avalia√ß√£o:")

    min_coerencia_global = st.slider(
        "Coer√™ncia Global m√≠nima (%)", 50, 100, DEFAULTS["min_coerencia_global"]
    )
    min_pairwise = st.slider(
        "Coer√™ncia par-a-par m√≠nima (%)", 50, 100, DEFAULTS["min_pairwise"]
    )
    max_staleness_days = st.slider(
        "M√°x. dias sem auditoria", 1, 30, DEFAULTS["max_staleness_days"]
    )
    max_wc_change_pct = st.slider(
        "M√°x. varia√ß√£o de tamanho (%)", 5, 100, DEFAULTS["max_wc_change_pct"]
    )

    cfg = {
        "min_coerencia_global": min_coerencia_global,
        "min_pairwise": min_pairwise,
        "max_staleness_days": max_staleness_days,
        "max_wc_change_pct": max_wc_change_pct,
    }

    if st.button("üîç Reexecutar an√°lise", use_container_width=True):
        st.session_state["alertas_result"] = evaluate_alerts(cfg)
        st.success("‚úÖ An√°lise reexecutada com sucesso.")


# --------------------------------------------------------------
# Execu√ß√£o principal
# --------------------------------------------------------------
if "alertas_result" not in st.session_state:
    st.session_state["alertas_result"] = evaluate_alerts(DEFAULTS)

resultado = st.session_state["alertas_result"]
totais = resultado.get("totais", {})
alertas = resultado.get("alerts", [])
ts = resultado.get("timestamp", datetime.now().strftime("%d/%m/%Y %H:%M:%S"))

# --------------------------------------------------------------
# Cabe√ßalho de resumo
# --------------------------------------------------------------
col1, col2, col3, col4 = st.columns(4)
col1.metric("Total de Alertas", totais.get("geral", 0))
col2.metric("Alta Severidade", totais.get("alto", 0))
col3.metric("M√©dia Severidade", totais.get("medio", 0))
col4.metric("Baixa Severidade", totais.get("baixo", 0))
st.caption(f"√öltima atualiza√ß√£o: {ts}")

# --------------------------------------------------------------
# Tabela de alertas
# --------------------------------------------------------------
if not alertas:
    st.info("‚úÖ Nenhum alerta ativo no momento. Todos os artefatos est√£o coerentes e atualizados.")
else:
    st.divider()
    st.subheader("üìã Lista de alertas detectados")

    for a in alertas:
        color = {
            "alto": "üî¥",
            "medio": "üü†",
            "baixo": "üü°",
        }.get(a["severidade"], "‚ö™")

        with st.expander(f"{color} {a['titulo']} ({a['area']})"):
            st.markdown(f"**Artefato:** {a.get('artefato', '-')}")
            st.markdown(f"**Detalhe:** {a['detalhe']}")
            st.markdown(f"**Recomenda√ß√£o:** {a['recomendacao']}")
            st.markdown(f"**Timestamp:** {a['timestamp']}")

# --------------------------------------------------------------
# Exporta√ß√£o
# --------------------------------------------------------------
st.divider()
if st.button("üíæ Exportar alertas para JSON", use_container_width=True):
    path = export_alerts_json(resultado)
    st.success(f"‚úÖ Arquivo exportado com sucesso: `{os.path.basename(path)}`")
    with open(path, "r", encoding="utf-8") as f:
        data = json.load(f)
    st.download_button(
        label="‚¨áÔ∏è Baixar arquivo JSON",
        data=json.dumps(data, indent=2, ensure_ascii=False),
        file_name=os.path.basename(path),
        mime="application/json",
    )

st.caption("Sistema SynapseNext vNext ‚Äì Secretaria de Administra√ß√£o e Abastecimento (SAAB/TJSP)")