import sys, os
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '../../')))
# ==========================================================
# üß© Validador de Editais ‚Äì SynapseNext vNext
# Secretaria de Administra√ß√£o e Abastecimento (SAAB/TJSP)
# ==========================================================
# Fun√ß√£o: validar a minuta do edital (manual ou gerada via IA)
# A partir de 2025.10, o m√≥dulo est√° integrado ao agente Edital.IA
# ==========================================================

import streamlit as st
import json
import os
from datetime import datetime
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from utils.ui_components import aplicar_estilo_global, exibir_cabecalho_padrao

# ----------------------------------------------------------
# ‚öôÔ∏è Configura√ß√£o de P√°gina
# ----------------------------------------------------------
st.set_page_config(page_title="üß© Validador de Editais", layout="wide", page_icon="üß©")
aplicar_estilo_global()

exibir_cabecalho_padrao(
    "üß© Validador de Editais",
    "An√°lise sem√¢ntica e conformidade institucional ‚Äì SynapseNext vNext"
)
st.divider()

# ==========================================================
# üß† Carregamento de artefato Edital.IA (sess√£o ativa)
# ==========================================================
texto = ""
if st.session_state.get("last_edital"):
    edital_ativo = st.session_state["last_edital"]
    st.success("üìé Minuta de Edital detectada ‚Äì carregada automaticamente para valida√ß√£o.")
    texto = "\n".join(f"{k}: {v}" for k, v in edital_ativo.items())
else:
    st.info("Nenhum Edital ativo encontrado. Cole o conte√∫do manualmente para validar.")

# ==========================================================
# üìã Entrada de Dados (manual se necess√°rio)
# ==========================================================
if not texto:
    st.subheader("üñäÔ∏è Insira o conte√∫do do edital para valida√ß√£o:")
    texto = st.text_area(
        "Cole o conte√∫do (ou parte) do edital abaixo:",
        height=220,
        placeholder="Exemplo: O presente edital tem por objeto a contrata√ß√£o de servi√ßos de manuten√ß√£o...",
        label_visibility="collapsed",
    )

tipo = st.selectbox(
    "Selecione o tipo de contrata√ß√£o:",
    ["Servi√ßos", "Materiais", "Obras", "TI & Software", "Consultorias"],
    index=0 if not st.session_state.get("last_edital") else 1,
)

executar = st.button("üîç Executar valida√ß√£o sem√¢ntica")

# ==========================================================
# üßÆ Valida√ß√£o Simb√≥lica e Sem√¢ntica
# ==========================================================
def validar_conteudo_edital(texto: str, tipo: str):
    """
    Valida√ß√£o institucional simb√≥lica.
    Em ambientes integrados, carrega validadores oficiais do TJSP.
    """
    resultado = {"itens": [], "observacoes": [], "status": "OK"}

    if not texto.strip():
        resultado["status"] = "Vazio"
        resultado["observacoes"].append("Nenhum conte√∫do foi informado para valida√ß√£o.")
        return resultado

    texto_lower = texto.lower()
    palavras_chave = {
        "Servi√ßos": ["presta√ß√£o", "execu√ß√£o", "contratada", "objeto"],
        "Materiais": ["fornecimento", "quantidade", "entrega", "itens"],
        "Obras": ["execu√ß√£o", "obra", "engenharia", "projeto"],
        "TI & Software": ["sistema", "licen√ßa", "tecnologia", "software"],
        "Consultorias": ["consultoria", "especializada", "estudos", "pareceres"],
    }

    obrigatorios = ["prazo", "pagamento", "penalidade", "objeto", "crit√©rios"]
    faltantes = []

    for termo in obrigatorios:
        if termo not in texto_lower:
            faltantes.append(termo)

    chaves_tipo = palavras_chave.get(tipo, [])
    tipo_encontrado = any(p in texto_lower for p in chaves_tipo)

    if not tipo_encontrado:
        resultado["observacoes"].append(f"O texto n√£o cont√©m termos t√≠picos de '{tipo}'.")

    if faltantes:
        resultado["status"] = "Incompleto"
        resultado["itens"].append({
            "categoria": "Campos obrigat√≥rios ausentes",
            "detalhes": faltantes
        })
        resultado["observacoes"].append(
            "Foram detectadas lacunas em campos essenciais: " + ", ".join(faltantes)
        )

    if resultado["status"] == "OK":
        resultado["observacoes"].append("O edital cont√©m os principais elementos esperados para o tipo selecionado.")
        resultado["itens"].append({"categoria": "Valida√ß√£o geral", "detalhes": ["Conformidade b√°sica verificada."]})

    return resultado

# ==========================================================
# üßæ Execu√ß√£o
# ==========================================================
if executar:
    st.info("Executando valida√ß√£o do edital...")

    resultado = validar_conteudo_edital(texto, tipo)

    st.subheader("üìä Resultado da Valida√ß√£o")
    st.write(f"**Status:** {resultado['status']}")

    if resultado["itens"]:
        for item in resultado["itens"]:
            st.markdown(f"**{item['categoria']}**")
            st.markdown("- " + "\n- ".join(item["detalhes"]))

    if resultado["observacoes"]:
        st.divider()
        st.subheader("üìã Observa√ß√µes")
        for obs in resultado["observacoes"]:
            st.markdown(f"- {obs}")

    # ------------------------------------------------------
    # üìÑ Exporta√ß√£o de Relat√≥rio em PDF
    # ------------------------------------------------------
    if st.button("üíæ Exportar relat√≥rio em PDF"):
        os.makedirs("exports/relatorios", exist_ok=True)
        arquivo_pdf = f"exports/relatorios/validacao_edital_{datetime.now().strftime('%Y%m%d_%H%M%S')}.pdf"

        c = canvas.Canvas(arquivo_pdf, pagesize=A4)
        c.setFont("Helvetica-Bold", 14)
        c.drawString(50, 800, "Relat√≥rio de Valida√ß√£o ‚Äì Edital de Licita√ß√£o")
        c.setFont("Helvetica", 10)
        c.drawString(50, 780, f"Tipo de contrata√ß√£o: {tipo}")
        c.drawString(50, 765, f"Status: {resultado['status']}")
        y = 740
        for obs in resultado["observacoes"]:
            c.drawString(50, y, f"- {obs}")
            y -= 15
        c.save()
        st.success(f"‚úÖ Relat√≥rio exportado para {arquivo_pdf}")

st.caption("üí° O validador detecta a estrutura textual essencial e aponta lacunas no Edital, conforme o tipo selecionado.")