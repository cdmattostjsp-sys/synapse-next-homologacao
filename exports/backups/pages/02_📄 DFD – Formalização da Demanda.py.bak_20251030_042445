# ==========================================================
# pages/02_üìÑ DFD ‚Äì Formaliza√ß√£o da Demanda.py
# SynapseNext ‚Äì Secretaria de Administra√ß√£o e Abastecimento (TJSP)
# Revis√£o: Engenheiro Synapse ‚Äì restabelecer fluxo INSUMOS ‚Üí IA ‚Üí DFD
# ==========================================================

import os
import json
from pathlib import Path
from io import BytesIO

import streamlit as st
from docx import Document

# ==========================================================
# üì¶ Imports institucionais
# ==========================================================
from utils.agents_bridge import AgentsBridge
from utils.ui_components import aplicar_estilo_global, exibir_cabecalho_padrao

# ==========================================================
# ‚öôÔ∏è Configura√ß√£o inicial
# ==========================================================
st.set_page_config(
    page_title="üìÑ DFD ‚Äì Formaliza√ß√£o da Demanda",
    layout="wide",
    page_icon="üìÑ",
)
aplicar_estilo_global()

exibir_cabecalho_padrao(
    "üìÑ Formaliza√ß√£o da Demanda (DFD)",
    "Registro institucional da demanda e gera√ß√£o de rascunho com IA"
)
st.divider()

# ==========================================================
# üõ† utilit√°rios locais
# ==========================================================
def _load_insumo_from_session() -> dict:
    """Tenta pegar o que o m√≥dulo INSUMOS j√° colocou na sess√£o."""
    return st.session_state.get("dfd_campos_ai", {})


def _load_insumo_from_disk() -> dict:
    """
    Fallback em disco:
    1) exports/insumos/json/DFD_ultimo.json  (novo fluxo INSUMOS)
    2) exports/dfd_data.json                 (fluxo legado)
    """
    # 1Ô∏è‚É£ novo fluxo
    p1 = Path("exports") / "insumos" / "json" / "DFD_ultimo.json"
    if p1.exists():
        try:
            with open(p1, "r", encoding="utf-8") as f:
                data = json.load(f)
            # o integration_insumos salva em "campos_ai"
            if isinstance(data, dict) and "campos_ai" in data:
                return data["campos_ai"]
            return data
        except Exception:
            pass

    # 2Ô∏è‚É£ fluxo antigo
    p2 = Path("exports") / "dfd_data.json"
    if p2.exists():
        try:
            with open(p2, "r", encoding="utf-8") as f:
                data = json.load(f)
            return data
        except Exception:
            pass

    return {}


def _make_json_safe(obj):
    """
    Remove do dicion√°rio objetos da OpenAI (ex.: CompletionUsage) e
    qualquer coisa que n√£o seja serializ√°vel.
    """
    if isinstance(obj, dict):
        clean = {}
        for k, v in obj.items():
            # filtra campos t√≠picos de uso da API
            if k in ("usage", "_usage", "system_fingerprint"):
                continue
            clean[k] = _make_json_safe(v)
        return clean
    elif isinstance(obj, list):
        return [_make_json_safe(x) for x in obj]
    else:
        try:
            json.dumps(obj)
            return obj
        except TypeError:
            return str(obj)


# ==========================================================
# üîÑ Carregar dados vindos do INSUMOS / IA
# ==========================================================
campos_ai = _load_insumo_from_session()
if not campos_ai:
    campos_ai = _load_insumo_from_disk()

# mapeamento m√≠nimo dos nomes que costumam vir da IA
unidade_default = (
    campos_ai.get("unidade")
    or campos_ai.get("unidade_demandante")
    or ""
)
descricao_default = (
    campos_ai.get("objeto")
    or campos_ai.get("descricao")
    or ""
)
motivacao_default = (
    campos_ai.get("justificativa")
    or campos_ai.get("motivacao")
    or ""
)
prazo_default = campos_ai.get("prazo_execucao", "")
estimativa_default = float(campos_ai.get("estimativa_valor", 0) or 0)

# ==========================================================
# üßæ Formul√°rio DFD (agora pr√©-preenchido)
# ==========================================================
st.subheader("1Ô∏è‚É£ Entrada ‚Äì Formaliza√ß√£o da Demanda")

with st.form("form_dfd"):
    col1, col2 = st.columns(2)

    with col1:
        unidade = st.text_input(
            "Unidade Demandante",
            value=unidade_default,
            placeholder="Ex.: Secretaria de Administra√ß√£o e Abastecimento ‚Äì SAAB",
            key="dfd_unidade",
        )
        responsavel = st.text_input(
            "Respons√°vel pela Demanda",
            key="dfd_responsavel",
        )
        prazo = st.text_input(
            "Prazo Estimado para Atendimento",
            value=prazo_default,
            key="dfd_prazo",
        )

    with col2:
        descricao = st.text_area(
            "Descri√ß√£o da Necessidade",
            height=100,
            value=descricao_default,
            key="dfd_descricao",
        )
        motivacao = st.text_area(
            "Motiva√ß√£o da Contrata√ß√£o",
            height=100,
            value=motivacao_default,
            key="dfd_motivacao",
        )
        estimativa_valor = st.number_input(
            "Estimativa de Valor (R$)",
            min_value=0.0,
            step=1000.0,
            value=estimativa_default,
            key="dfd_estimativa_valor",
        )

    colb1, colb2 = st.columns(2)
    with colb1:
        gerar_ia = st.form_submit_button("‚öôÔ∏è Gerar rascunho com IA institucional")
    with colb2:
        salvar_manual = st.form_submit_button("üíæ Salvar dados manualmente")

# ==========================================================
# üé® Estilo institucional (mesmo padr√£o das outras p√°ginas)
# ==========================================================
st.markdown(
    """
<style>
div.stButton > button:first-child {
    background-color: #003366 !important;
    color: white !important;
    border: none !important;
    border-radius: 8px !important;
    height: 2.8em !important;
    font-weight: 500 !important;
}
div.stButton > button:first-child:hover {
    background-color: #002244 !important;
    color: white !important;
    transition: 0.15s;
}
</style>
""",
    unsafe_allow_html=True,
)

# ==========================================================
# üíæ Salvamento manual (fallback)
# ==========================================================
if salvar_manual:
    dfd_data = {
        "unidade": unidade,
        "responsavel": responsavel,
        "prazo": prazo,
        "descricao": descricao,
        "motivacao": motivacao,
        "estimativa_valor": estimativa_valor,
    }
    st.success("‚úÖ Dados do DFD salvos manualmente.")
    st.json(dfd_data)
    st.session_state["last_dfd"] = dfd_data

# ==========================================================
# ü§ñ Gera√ß√£o IA Institucional (agente interno)
# ==========================================================
if gerar_ia:
    st.info("Executando agente institucional DFD com base nos campos preenchidos e no insumo recebido...")
    # metadados que vamos entregar ao agente
    metadata = {
        "unidade": unidade,
        "responsavel": responsavel,
        "prazo": prazo,
        "descricao": descricao,
        "motivacao": motivacao,
        "estimativa_valor": estimativa_valor,
        "campos_ai": campos_ai,     # üü£ o que veio do INSUMOS + IA
        "origem": "pagina_dfd_streamlit",
    }

    try:
        bridge = AgentsBridge("DFD")
        raw_result = bridge.generate(metadata)

        # tornamos o retorno serializ√°vel
        resultado = _make_json_safe(raw_result)

        st.success("‚úÖ Rascunho gerado com sucesso pelo agente DFD.IA!")
        st.json(resultado)

        # guardamos na sess√£o
        st.session_state["last_dfd"] = resultado

        # tamb√©m salvamos a vers√£o mais recente no formato antigo
        exports_dir = Path("exports")
        exports_dir.mkdir(exist_ok=True)
        json_path = exports_dir / "dfd_data.json"
        with open(json_path, "w", encoding="utf-8") as f:
            json.dump(resultado, f, ensure_ascii=False, indent=2)
        st.info(f"üíæ DFD exportado para {json_path}")

    except Exception as e:
        st.error(f"Erro ao gerar rascunho com IA: {e}")

# ==========================================================
# üì§ Exporta√ß√£o do Documento
# ==========================================================
if "last_dfd" in st.session_state and st.session_state["last_dfd"]:
    st.divider()
    st.subheader("üì§ Exporta√ß√£o de Documento")
    st.info("Baixe o √∫ltimo DFD gerado em formato Word edit√°vel.")

    dfd_data = st.session_state["last_dfd"]
    doc = Document()
    doc.add_heading("Formaliza√ß√£o da Demanda (DFD)", level=1)

    if isinstance(dfd_data, dict):
        for k, v in dfd_data.items():
            p = doc.add_paragraph()
            p.add_run(f"{k}: ").bold = True
            p.add_run(str(v) or "‚Äî")
    else:
        doc.add_paragraph(str(dfd_data))

    buffer = BytesIO()
    doc.save(buffer)
    buffer.seek(0)
    st.download_button("üíæ Baixar DFD_rascunho.docx", buffer, file_name="DFD_rascunho.docx")

    st.markdown("---")
    if st.button("üì¶ Exportar DFD (JSON)"):
        try:
            exports_dir = Path("exports")
            exports_dir.mkdir(exist_ok=True)
            json_path = exports_dir / "dfd_data.json"
            with open(json_path, "w", encoding="utf-8") as f:
                json.dump(_make_json_safe(dfd_data), f, ensure_ascii=False, indent=2)
            st.success(f"‚úÖ DFD exportado com sucesso para {json_path}")
        except Exception as e:
            st.error(f"Falha ao exportar DFD: {e}")

st.caption(
    "üí° Este m√≥dulo aceita preenchimento manual, mas d√° prioridade ao insumo pr√©-processado pelo m√≥dulo INSUMOS + IA institucional."
)
