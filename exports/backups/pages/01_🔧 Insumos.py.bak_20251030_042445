# ==========================================================
# pages/01_üîß Insumos.py  ‚Äì  SynapseNext / SAAB TJSP
# Revis√£o: Engenheiro Synapse ‚Äì INC-2025-11-06-AI-PIPELINE-FIX
# ==========================================================

import sys, os, json, fitz, docx2txt
from io import BytesIO
from datetime import datetime
from pathlib import Path
import streamlit as st

# ==========================================================
# üîç Importa√ß√µes compat√≠veis
# ==========================================================
try:
    from utils.integration_insumos import salvar_insumo, listar_insumos, processar_insumo
    from utils.ui_components import aplicar_estilo_global, exibir_cabecalho_padrao
except ModuleNotFoundError:
    base_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), "..", ".."))
    sys.path.insert(0, base_dir)
    from utils.integration_insumos import salvar_insumo, listar_insumos, processar_insumo
    from utils.ui_components import aplicar_estilo_global, exibir_cabecalho_padrao

# ==========================================================
# ‚öôÔ∏è Configura√ß√£o
# ==========================================================
st.set_page_config(page_title="üîß Insumos", layout="wide", page_icon="üîß")
aplicar_estilo_global()

# --- Protege o estado da sess√£o
if "dfd_campos_ai" not in st.session_state:
    st.session_state["dfd_campos_ai"] = {}

# --- Garante estrutura de diret√≥rios
# --- Ajuste compat√≠vel com Streamlit Cloud
BASE_EXPORT_DIR = Path("exports")
EXPORTS_JSON_DIR = BASE_EXPORT_DIR / "insumos" / "json"

try:
    EXPORTS_JSON_DIR.mkdir(parents=True, exist_ok=True)
except Exception:
    # Fallback seguro: usa pasta tempor√°ria do ambiente Cloud
    EXPORTS_JSON_DIR = Path("/tmp") / "insumos" / "json"
    EXPORTS_JSON_DIR.mkdir(parents=True, exist_ok=True)

# ==========================================================
# üèõÔ∏è Cabe√ßalho institucional
# ==========================================================
exibir_cabecalho_padrao(
    "üîß Upload de Insumos Institucionais",
    "Integra√ß√£o inteligente entre artefatos e dados do SynapseNext"
)
st.divider()

st.markdown("""
O m√≥dulo **INSUMOS** permite anexar documentos institucionais (DFD, ETP, TR, Edital, Contrato)  
que servir√£o de base para os artefatos gerados automaticamente pelo SynapseNext.  
Cada upload √© registrado e o conte√∫do pode ser processado semanticamente pela IA  
para preenchimento inteligente do artefato correspondente.
""")

# ==========================================================
# üìÇ Upload de documento
# ==========================================================
st.divider()
st.subheader("üìé Enviar novo insumo")

col1, col2, col3 = st.columns([2, 2, 1])
with col1:
    artefato = st.selectbox("Artefato relacionado", ["DFD", "ETP", "TR", "EDITAL", "CONTRATO"])
with col2:
    descricao = st.text_input("Descri√ß√£o / Observa√ß√£o", placeholder="Ex: Estudo t√©cnico preliminar revisado")
with col3:
    usuario = st.text_input("Nome do remetente", placeholder="Ex: Carlos Mattos")

arquivo = st.file_uploader("Selecione o arquivo (DOCX, PDF, TXT etc.)", type=["docx", "pdf", "txt"])

# ==========================================================
# üßæ Processamento do upload
# ==========================================================
if arquivo and st.button("üì§ Enviar insumo"):
    with st.spinner("Salvando e processando o documento..."):
        try:
            caminho_salvo = salvar_insumo(arquivo, artefato)
            st.success(f"Insumo '{arquivo.name}' salvo com sucesso em {caminho_salvo}")
        except Exception as e:
            st.error(f"Erro ao salvar insumo: {e}")
            st.stop()

        # Extra√ß√£o de texto
        texto_extraido = ""
        try:
            nome = arquivo.name.lower()
            arquivo.seek(0)
            dados = arquivo.read()
            if nome.endswith(".pdf"):
                pdf = fitz.open(stream=dados, filetype="pdf")
                texto_extraido = "".join(p.get_text() for p in pdf)
            elif nome.endswith(".docx"):
                texto_extraido = docx2txt.process(BytesIO(dados))
            elif nome.endswith(".txt"):
                texto_extraido = dados.decode("utf-8", errors="ignore")
        except Exception as e:
            st.error(f"Erro ao extrair texto: {e}")

        # Processamento com IA
        campos_ai = {}
        if texto_extraido.strip():
            try:
                st.info("ü§ñ IA processando o insumo e identificando campos relevantes...")
                campos_ai = processar_insumo(arquivo, artefato)
            except Exception as e:
                st.error(f"Erro no processamento IA: {e}")
        else:
            st.warning("‚ö†Ô∏è N√£o foi poss√≠vel extrair texto leg√≠vel do arquivo enviado.")

        # ======================================================
        # üíæ Registro e exporta√ß√£o
        # ======================================================
        chave = f"last_insumo_{artefato.lower()}"
        st.session_state[chave] = {
            "nome": arquivo.name,
            "artefato": artefato,
            "conteudo": (texto_extraido or "")[:100000],
            "campos_ai": campos_ai or {},
            "usuario": usuario,
            "descricao": descricao,
            "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        }

        # --- salva JSON em pasta institucional
        try:
            nome_base = f"{artefato}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
            ultimo_json = EXPORTS_JSON_DIR / f"{artefato}_ultimo.json"
            with open(ultimo_json, "w", encoding="utf-8") as f:
                json.dump({"campos_ai": campos_ai}, f, ensure_ascii=False, indent=2)
            st.session_state["dfd_campos_ai"] = campos_ai
            st.success(f"üì¶ Dados do insumo exportados para {ultimo_json.name}")
        except Exception as e:
            st.error(f"Erro ao salvar dados processados: {e}")

        st.success(f"üìé Insumo armazenado e dispon√≠vel para o artefato **{artefato}**.")

# ==========================================================
# üóÇÔ∏è Hist√≥rico de uploads
# ==========================================================
st.divider()
st.subheader("üóÇÔ∏è Hist√≥rico de Insumos Enviados")

artefato_hist = st.selectbox("Filtrar por artefato", ["Todos", "DFD", "ETP", "TR", "EDITAL", "CONTRATO"])

if artefato_hist == "Todos":
    for tipo in ["DFD", "ETP", "TR", "EDITAL", "CONTRATO"]:
        arquivos = listar_insumos()
        st.markdown(f"#### üìò {tipo}")
        st.write(arquivos or "‚Äî sem arquivos ‚Äî")
else:
    arquivos = listar_insumos()
    st.markdown(f"#### üìò {artefato_hist}")
    st.write(arquivos or "Nenhum insumo encontrado para o artefato selecionado.")
